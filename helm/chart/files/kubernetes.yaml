# All container logs are maintained as symlinks onto the node
pipeline:
  inputs:
    - name: tail
      path: /var/log/containers/*.log
      multiline.parser: docker, cri
      tag: kube.*
      db: /var/log/fluent-bit-containers.db
      db.sync: normal
      mem_buf_limit: 50MB
      skip_long_lines: on
      refresh_interval: 10
      read_from_head: true

  filters:
    # Add kubernetes metadata
    - name: kubernetes
      match: kube.*
      kube_url: https://kubernetes.default.svc:443
      kube_ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      kube_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      kube_tag_prefix: kube.var.log.containers.
      merge_log: on
      merge_log_key: log_processed
      k8s-logging.parser: on
      k8s-logging.exclude: off
      annotations: off
      labels: off

    # Parse nested JSON log messages
    - name: parser
      match: kube.*
      key_name: log
      parser: json
      reserve_data: on
      preserve_key: on

    # Don't emit logs for all system pods
    - name: grep
      match: kube.*
      exclude:
        - kubernetes_namespace_name: kube-system
        - kubernetes_namespace_name: kube-public
        - kubernetes_namespace_name: kube-node-lease

    # Don't emit logs for JupyterHub specific pods
    # - name: grep
    #   match: kube.*
    #   exclude:
    #     - kubernetes_pod_name: .*-hub.*

  outputs:
    # Push all container logs to Loggly
    - name: http
      match: kube.*
      host: logs-01.loggly.com
      port: 443
      uri: /bulk/${FLUENTD__LOGGLY_TOKEN}/tag/testing/
      header: Content-Type application/json
      format: json_lines
      json_date_key: "@timestamp"
      json_date_format: iso8601
      tls: on
      tls.verify: on
      retry_limit: 5

    # Push all container logs to Logzio
    # - name: http
    #   match: kube.*
    #   host: listener.logz.io
    #   port: 8070
    #   uri: /?token=${FLUENTD__LOGZIO_TOKEN}&type=fluentbit
    #   header: Content-Type application/json
    #   format: json_lines
    #   json_date_key: "@timestamp"
    #   json_date_format: iso8601
    #   tls: on
    #   tls.verify: on
    #   retry_limit: 5
