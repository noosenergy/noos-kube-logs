# All container logs are maintained as symlinks onto the node
pipeline:
  inputs:
    - name: tail
      path: /var/log/containers/*.log
      multiline.parser: docker, cri
      tag: kube.*
      db: /var/log/fluent-bit-containers.db
      db.sync: normal
      mem_buf_limit: 50MB
      skip_long_lines: on
      refresh_interval: 10
      read_from_head: true

  filters:
    # Add kubernetes metadata
    - name: kubernetes
      match: kube.*
      merge_log: on
      keep_log: off
      k8s-logging.parser: on
      k8s-logging.exclude: off

    # Parse nested JSON log messages
    # - name: parser
    #   match: kube.*
    #   key_name: log
    #   parser: json
    #   reserve_data: on
    #   preserve_key: on

    # Don't emit logs for all system pods
    - name: grep
      match: kube.*
      exclude:
        - $kubernetes['namespace_name'] kube-system
        - $kubernetes['namespace_name'] kube-public
        - $kubernetes['namespace_name'] kube-node-lease

    # Don't emit logs for JupyterHub specific pods
    - name: grep
      match: kube.*
      exclude:
        - $kubernetes['pod_name'] .*-hub.*
        - $kubernetes['pod_name''] .*fluent-bit.*

  outputs:
    # Push all container logs to Loggly
    - name: http
      match: kube.*
      host: logs-01.loggly.com
      port: 443
      uri: /bulk/${FLUENTD__LOGGLY_TOKEN}/tag/testing/
      header: Content-Type application/json
      format: json_lines
      json_date_key: "@timestamp"
      json_date_format: iso8601
      tls: on
      tls.verify: on
      retry_limit: 5

    # - name: stdout
    #   match: kube.*

    - name: http
      match: kube.*
      tls: on
      host: ${BETTERSTACK_HOST}
      port: 443
      uri: /fluentbit
      header:
        - Authorization Bearer ${BETTERSTACK_TOKEN}
        - Content-Type application/msgpack
      format: msgpack
      retry_limit: 5
    # Push all container logs to Logzio
    # - name: http
    #   match: kube.*
    #   host: listener.logz.io
    #   port: 8070
    #   uri: /?token=${FLUENTD__LOGZIO_TOKEN}&type=fluentbit
    #   header: Content-Type application/json
    #   format: json_lines
    #   json_date_key: "@timestamp"
    #   json_date_format: iso8601
    #   tls: on
    #   tls.verify: on
    #   retry_limit: 5
