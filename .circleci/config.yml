---
version: 2.1

default:
  filter: &filter-master-only
    filters:
      branches:
        only: master


# ----------------
# Orbs declaration
# ----------------

orbs:

  noos-ci: noosenergy/noos-ci@0.1.15


# --------------
# Pipeline tasks
# --------------

jobs:

  lint-chart:
    executor: noos-ci/default
    steps:
      - checkout
      - noos-ci/helm-lint-chart

  build-chart:
    executor: noos-ci/default
    steps:
      - checkout
      - noos-ci/helm-build-chart:
          registry-provider: aws
          chart-name: noos-prod/kube-logs

  build-image:
    executor: noos-ci/default
    steps:
      - checkout
      - noos-ci/docker-build-image:
          registry-provider: docker
          image-context: ./docker/exporter
          image-name: fluentd
          image-tag: ${CIRCLE_SHA1}

  deploy:
    executor: noos-ci/default
    steps:
      - checkout
      - noos-ci/terraform-update-variable:
          workspace: noos-prod
          variable-name: kube_logs_exporter_image_tag
          variable-value: ${CIRCLE_SHA1}
      - noos-ci/terraform-run-plan:
          workspace: noos-prod
          plan-message: ${CIRCLE_BUILD_URL}


# -----------------
# Pipeline workflow
# -----------------

workflows:

  lint-build-deploy:
    jobs:
      - lint-chart
      - hold:
          type: approval
          <<: *filter-master-only
      - build-chart:
          context: CIRCLECI_SHARED
          requires:
            - hold
          <<: *filter-master-only
      - build-image:
          context: DOCKERHUB_SHARED
          requires:
            - hold
          <<: *filter-master-only
      - deploy:
          context: NOOS_PROD_SHARED
          requires:
            - build-chart
            - build-image
          <<: *filter-master-only
